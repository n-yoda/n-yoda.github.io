<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Test</title>
</head>
<body>
  <div>src: <input type="file" id="src"/></div>
  <div>
    <canvas id="src-canvas" width="128" height="128"></canvas>
  </div>
  <div>
    <canvas id="dst-canvas" width="128" height="128"></canvas>
  </div>
  <div id="exp-label">逆ポーランド記法：</div>
  <div id="exp"></div>
<script>
const srcCanvas = document.getElementById('src-canvas');
const dstCanvas = document.getElementById('dst-canvas');
const srcCtx =  srcCanvas.getContext('2d');
const dstCtx =  dstCanvas.getContext('2d');
const src = document.getElementById('src');
const exp = document.getElementById('exp');
const opsDef = {
  'x': x => x.push(x.x),
  'y': x => x.push(x.y),
  '+': x => x.push(x.pop() + x.pop()),
  '-': x => x.push(x.pop() - x.pop()),
  '*': x => x.push(x.pop() * x.pop()),
  '/': x => x.push(x.pop() / x.pop()),
  'max': x => x.push(Math.max(x.pop(), x.pop())),
  'min': x => x.push(Math.min(x.pop(), x.pop())),
  'atan2': x => x.push(Math.atan2(x.pop(), x.pop())),
  'sin': x => x.push(Math.sin(x.pop())),
  'cos': x => x.push(Math.cos(x.pop())),
  'abs': x => x.push(Math.abs(x.pop())),
  'sqrt': x => x.push(Math.sqrt(x.pop())),
  'exp': x => x.push(Math.exp(x.pop())),
  'log': x => x.push(Math.log(x.pop())),
};
const numMax = 15;
for (let i = 0; i <= numMax; i++) {
  opsDef[i] = x => x.push(i);
}
const ops = [];
for (let opName in opsDef) {
  op = opsDef[opName];
  op.opName = opName;
  let count = 0;
  op({push: x => count++, pop: () => count--, x: 0, y: 0});
  op.opArity = count;
  ops.push(op);
  console.log(op.opName + ':' + op.opArity);
}
function randomInt(max) {
  return Math.floor(Math.random() * max);
}
function randomOp() {
  return ops[randomInt(ops.length)];
}
function randomOps() {
  const len = 3 + randomInt(62);
  const result = [];
  result.opsStr = '';
  let stack = 0;
  while (result.length < len) {
    let op = randomOp();
    next = stack + op.opArity;
    if (0 < next && next <= len - result.length) {
      result.push(op);
      result.opsStr += ' ' + op.opName;
      stack = next;
    }
  }
  return result;
}

function imagePromise(url) {
  return new Promise((resolve, reject) => {
    const img  = new Image();
    img.src = url;
    img.addEventListener('load', () => resolve(img));
    img.addEventListener('error', () => reject(img));
  });
}

let imageData = dstCtx.createImageData(dstCanvas.width, dstCanvas.height);
src.addEventListener('change', function() {
  if (src.files.length < 1) {
    console.log('src is empty');
    return;
  }
  const url = URL.createObjectURL(src.files[0]);
  imagePromise(url).then(img => {
    srcCtx.drawImage(img, 0, 0, srcCanvas.width, srcCanvas.height);
    URL.revokeObjectURL(url);
    setInterval(() => {
      let func = randomOps();
      exp.textContent = func.opsStr;
      for (let y = 0; y < dstCanvas.height; ++y) {
        for (let x = 0; x < dstCanvas.width; ++x) {
          let stack = [];
          stack.x = (x + 0.5) / dstCanvas.width;
          stack.y = (y + 0.5) / dstCanvas.height;
          func.forEach(op => op(stack));
          let i = (y * dstCanvas.width + x) * 4;
          value = stack[0] * 255;
          imageData.data[i + 0] = value;
          imageData.data[i + 1] = value;
          imageData.data[i + 2] = value;
          imageData.data[i + 3] = 255;
        }
      }
      dstCtx.putImageData(imageData, 0, 0, 0, 0, dstCanvas.width, dstCanvas.height);
    }, 0);
  });
});
</script>
</body>
</html>
